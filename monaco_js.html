<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>Mini FS Editor (Sidebar Fixed 250px)</title>
<style>
:root { --console-h: 150px; }

html, body {
  margin: 0; padding: 0;
  height: 100%; width: 100%;
  overflow: hidden;
  font-family: "Cascadia Code", monospace;
  background: #1e1e1e; color: #ddd;
}
#container { display: flex; height: 100vh; width: 100vw; }

/* 사이드바 */
#sidebar {
  width: 250px;
  min-width: 0; /* flex overflow 방지 */
  background: #252526; border-right: 1px solid #333;
  display: flex; flex-direction: column;
  transition: width 0.2s ease;
  overflow: hidden;
}
#sidebar.collapsed { width: 0; }

/* 사이드바 옆 토글 버튼 */
#sidebar-toggle {
  width: 12px;
  background: #333;
  border: none;
  color: #eee;
  cursor: pointer;
  padding: 0;
}

#main {
  flex: 1; display: flex; flex-direction: column;
  min-width: 0; min-height: 0; /* flex 자식 레이아웃 안정화 */
}
#editor {
  height: calc(100vh - var(--console-h)); /* 콘솔 높이에 따라 자동 조절 */
  width: 100%;
  transition: height 0.2s ease;
}
#console-toggle {
  background: #333; border: none; color: #eee;
  font-size: 12px; padding: 4px 8px; cursor: pointer;
  text-align: left; width: 100%;
}
#console {
  height: var(--console-h);
  background: #111; border-top: 1px solid #333;
  display: flex; flex-direction: column;
  transition: height 0.2s ease;
  overflow: hidden;
}
#console-output {
  flex: 1; overflow-y: auto; font-size: 12px; padding: 6px; color: #0f0;
}
#console-input { height: 60px; }
#toolbar {
  display: flex; justify-content: space-around;
  padding: 6px; border-bottom: 1px solid #333;
}
#toolbar button {
  background: none; border: none; color: #eee;
  font-size: 18px; cursor: pointer;
}
#file-list { flex: 1; overflow-y: auto; padding: 6px; font-size: 13px; }
.file-item { padding: 4px 8px; cursor: pointer; border-radius: 3px; user-select: none; }
.file-item:hover { background: #333; }
.file-item.active { background: #444; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
</head>
<body>
<div id="container">
  <div id="sidebar">
    <div id="toolbar">
      <button id="btnNew" title="New">✨</button>
      <button id="btnDelete" title="Delete">🗑️</button>
      <button id="btnSave" title="Save (가상FS)">💾</button>
      <button id="btnOpen" title="Open">📂</button>
      <button id="btnDownload" title="Download">⬇️</button>
    </div>
    <div id="file-list" aria-label="Files"></div>
  </div>
  <button id="sidebar-toggle">◀</button>
  <div id="main">
    <div id="editor"></div>
    <button id="console-toggle">▼ Console</button>
    <div id="console">
      <div id="console-output"></div>
      <div id="console-input"></div>
    </div>
  </div>
</div>
<input type="file" id="fileInput" style="display:none" />

<script>
require.config({ paths: { vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs" } });

let editor, jsConsole;
let currentFile = null;
const files = {};

require(["vs/editor/editor.main"], function () {
  editor = monaco.editor.create(document.getElementById("editor"), {
    value: "",
    language: "plaintext",
    theme: "vs-dark",
    fontSize: 14,
    wordWrap: "on",
    folding: true,
    minimap: { enabled: true },
    automaticLayout: false
  });

  jsConsole = monaco.editor.create(document.getElementById("console-input"), {
    value: "// 예) 1,$ d • /foo/g,\"bar\" • console.log(\"hi\")",
    language: "javascript",
    theme: "vs-dark",
    fontSize: 13,
    minimap: { enabled: false },
    lineNumbers: "off",
    automaticLayout: false
  });

  jsConsole.onKeyDown(e => {
    if (e.keyCode === monaco.KeyCode.Enter) {
      if (e.shiftKey) return;
      const code = jsConsole.getValue().trim();
      jsConsole.setValue("");
      runCode(code);
      e.preventDefault();
    }
  });

  // 크기 변화 감지 → 모나코 레이아웃 갱신
  const ro = new ResizeObserver(() => {
    if (editor) editor.layout();
    if (jsConsole) jsConsole.layout();
  });
  ro.observe(document.getElementById("main"));
  ro.observe(document.getElementById("editor"));
  ro.observe(document.getElementById("console"));

  // 브라우저 리사이즈에도 대응
  window.addEventListener("resize", () => {
    if (editor) editor.layout();
    if (jsConsole) jsConsole.layout();
  });
});

function log(msg) {
  const out = document.getElementById("console-output");
  out.innerHTML += msg + "<br>";
  out.scrollTop = out.scrollHeight;
}

const origLog = console.log;
console.log = (...args) => {
  origLog(...args);
  log(args.join(" "));
};

function refreshList() {
  const list = document.getElementById("file-list");
  list.innerHTML = "";
  const names = Object.keys(files);
  if (!names.length) {
    list.innerHTML="<div style='color:#888;padding:6px'>파일이 없습니다. ✨ 또는 📂 버튼을 사용하세요.</div>";
    return;
  }
  names.forEach(fname => {
    const div = document.createElement("div");
    div.className = "file-item"+(fname===currentFile?" active":"");
    div.textContent = fname;
    div.onclick = ()=>openFile(fname);
    list.appendChild(div);
  });
}

function detectLanguage(fname) {
  const ext = fname.split(".").pop().toLowerCase();
  if(ext==="js") return "javascript";
  if(ext==="ts") return "typescript";
  if(ext==="md") return "markdown";
  if(ext==="cs") return "csharp";
  if(ext==="html"||ext==="htm") return "html";
  if(ext==="css") return "css";
  if(ext==="json") return "json";
  if(ext==="xml") return "xml";
  return "plaintext";
}

document.getElementById("btnNew").addEventListener("click", () => {
  const fname = prompt("새 파일 이름:", "untitled.txt");
  if(!fname || files[fname]) { alert("파일 존재"); return; }
  files[fname] = "";
  currentFile = fname;
  editor.setValue("");
  monaco.editor.setModelLanguage(editor.getModel(), detectLanguage(fname));
  refreshList();
  log(`생성됨: ${fname}`);
});

function openFile(fname) {
  currentFile = fname;
  const content = files[fname]??"";
  editor.setValue(content);
  monaco.editor.setModelLanguage(editor.getModel(), detectLanguage(fname));
  refreshList();
  log(`열림: ${fname}`);
}

document.getElementById("btnDelete").addEventListener("click", () => {
  if(!currentFile) return alert("열린 파일 없음");
  delete files[currentFile];
  currentFile = null;
  editor.setValue("");
  monaco.editor.setModelLanguage(editor.getModel(),"plaintext");
  refreshList();
  log("삭제됨 (가상 FS)");
});

document.getElementById("btnSave").addEventListener("click", () => {
  if(!currentFile) return alert("열린 파일 없음");
  files[currentFile] = editor.getValue();
  log("저장됨: "+currentFile);
});

document.getElementById("btnOpen").addEventListener("click", ()=>{
  const input = document.getElementById("fileInput");
  input.value = ""; // 같은 파일 재오픈 허용
  input.click();
});
document.getElementById("fileInput").addEventListener("change", (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    files[file.name] = reader.result;
    currentFile = file.name;
    editor.setValue(reader.result);
    monaco.editor.setModelLanguage(editor.getModel(), detectLanguage(file.name));
    refreshList();
    log(`로컬 파일 로드: ${file.name}`);
  };
  reader.readAsText(file,"UTF-8");
});

document.getElementById("btnDownload").addEventListener("click", () => {
  if(!currentFile) return alert("열린 파일 없음");
  const text = editor.getValue();
  const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = currentFile || "untitled.txt";
  a.click();
  URL.revokeObjectURL(url);
  log(`다운로드 완료: ${a.download}`);
});

// Sidebar toggle
const sidebar = document.getElementById("sidebar");
const sidebarToggle = document.getElementById("sidebar-toggle");

sidebarToggle.addEventListener("click", () => {
  sidebar.classList.toggle("collapsed");
  sidebarToggle.textContent = sidebar.classList.contains("collapsed") ? "▶" : "◀";

  // 토글 직후 레이아웃 갱신
  requestAnimationFrame(() => {
    if (editor) editor.layout();
    if (jsConsole) jsConsole.layout();
    requestAnimationFrame(() => {
      if (editor) editor.layout();
      if (jsConsole) jsConsole.layout();
    });
  });
});

// Console toggle (CSS 변수 기반)
const rootStyle = document.documentElement.style;
const toggleBtn = document.getElementById("console-toggle");
let consoleCollapsed = false;

function setConsoleHeight(px) {
  rootStyle.setProperty("--console-h", px);
  requestAnimationFrame(()=>{
    if (editor) editor.layout();
    if (jsConsole) jsConsole.layout();
    requestAnimationFrame(()=>{
      if (editor) editor.layout();
      if (jsConsole) jsConsole.layout();
    });
  });
}

toggleBtn.addEventListener("click",()=>{
  consoleCollapsed = !consoleCollapsed;
  if (consoleCollapsed) {
    setConsoleHeight("0px");
    toggleBtn.textContent = "▶ Console";
  } else {
    setConsoleHeight("150px");
    toggleBtn.textContent = "▼ Console";
  }
});

// JS 콘솔 실행 루틴 (d/s 명령 처리)
function runCode(code) {
  try {
    const model = editor.getModel();

    // d 명령
    const deleteMatch = code.match(/^(\d+|\$)(?:,(\d+|\$))?\s+d$/);
    if (deleteMatch) {
      const [, startStr, endStr] = deleteMatch;
      const start = startStr === "$" ? model.getLineCount() : parseInt(startStr, 10);
      const end   = endStr   === "$" ? model.getLineCount() : (endStr ? parseInt(endStr, 10) : start);
      const range = new monaco.Range(start, 1, end, model.getLineMaxColumn(end));
      editor.executeEdits("console-delete", [{ range, text: "" }]);
      log(`줄 ${startStr}${endStr ? "~" + endStr : ""} 삭제 완료`);
      return;
    }

    // 범위 치환
    const rangeMatch = code.match(/^(\d+|\$)(?:,(\d+|\$))?\s+\/(.+)\/(\w*)\s*,\s*["'](.+)["']$/);
    if (rangeMatch) {
      const [, startStr, endStr, pattern, flags, replacement] = rangeMatch;
      const start = startStr === "$" ? model.getLineCount() : parseInt(startStr, 10);
      const end   = endStr   === "$" ? model.getLineCount() : (endStr ? parseInt(endStr, 10) : start);
      const regex = new RegExp(pattern, flags);
      const edits = [];
      for (let i = start - 1; i < end && i < model.getLineCount(); i++) {
        const lineContent = model.getLineContent(i + 1);
        const newContent = lineContent.replace(regex, replacement);
        if (newContent !== lineContent) {
          edits.push({
            range: new monaco.Range(i + 1, 1, i + 1, lineContent.length + 1),
            text: newContent,
            forceMoveMarkers: true
          });
        }
      }
      if (edits.length > 0) {
        editor.executeEdits("console-replace", edits);
        log(`줄 ${startStr}${endStr ? "~" + endStr : ""} 치환 완료: ${regex} → "${replacement}"`);
      }
      return;
    }

    // 전역 치환
    const globalMatch = code.match(/^\/(.+)\/(\w*)\s*,\s*["'](.+)["']$/);
    if (globalMatch) {
      const [, pattern, flags, replacement] = globalMatch;
      const regex = new RegExp(pattern, flags);
      const fullText = model.getValue();
      const newText = fullText.replace(regex, replacement);
      if (newText !== fullText) {
        editor.executeEdits("console-replace", [
          { range: model.getFullModelRange(), text: newText, forceMoveMarkers: true }
        ]);
        log(`전역 치환 완료: ${regex} → "${replacement}"`);
      }
      return;
    }

    // 일반 JS 실행
    const result = eval(code);
    if (result !== undefined) log(String(result));
  } catch (err) {
    log("Error: " + err.message);
  }
}

// Ctrl+Z / Ctrl+Shift+Z Undo/Redo
window.addEventListener("keydown",(e)=>{
  if(!editor) return;
  if(e.ctrlKey && !e.shiftKey && e.key.toLowerCase()==="z"){
    e.preventDefault();
    editor.trigger("keyboard","undo",null);
  }
  if((e.ctrlKey && e.shiftKey && e.key.toLowerCase()==="z") || (e.ctrlKey && e.key.toLowerCase()==="y")){
    e.preventDefault();
    editor.trigger("keyboard","redo",null);
  }
});

// 새로고침(F5, Ctrl+R) 방지 팝업
window.addEventListener("beforeunload", function (e) {
  e.preventDefault();
  e.returnValue = ""; // 브라우저가 기본 경고창을 띄움
});
</script>
</body>
</html>
