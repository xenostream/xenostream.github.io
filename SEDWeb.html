<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Monaco + sed Demo</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
    }
    #editor {
      width: 100%;
      height: calc(100% - 40px);
    }
    #command-bar {
      height: 40px;
      display: flex;
      border-top: 1px solid #333;
      background: #1e1e1e;
    }
    #cmd {
      flex: 1;
      border: none;
      padding: 8px;
      font-size: 14px;
      background: #252526;
      color: #eee;
    }
    #run {
      width: 80px;
      border: none;
      background: #0e639c;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    #run:hover {
      background: #1177bb;
    }
  </style>
  <!-- Aioli -->
  <script src="https://biowasm.com/cdn/v3/aioli.js"></script>
  <!-- Monaco -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
</head>
<body>
  <div id="editor"></div>
  <div id="command-bar">
    <!-- placeholder 교체 -->
    <input id="cmd" placeholder="예: 's/OLD/NEW/g'   (a/i/c 멀티라인은 \n)" />
    <button id="run">Run</button>
  </div>

  <script>
    let editor;
    let currentFilename = "untitled.txt";

    // 확장자 → Monaco language 매핑
    const extToLang = {
      "js": "javascript","ts": "typescript","json": "json","html": "html","htm": "html",
      "css": "css","md": "markdown","xml": "xml","py": "python","c": "c","cpp": "cpp",
      "h": "cpp","hpp": "cpp","java": "java","cs": "csharp","rb": "ruby","php": "php",
      "sh": "shell","bat": "bat","ps1": "powershell","go": "go","rs": "rust","sql": "sql",
      "txt": "plaintext"
    };
    function getExtension(filename) {
      const parts = filename.split(".");
      return parts.length > 1 ? parts.pop().toLowerCase() : "";
    }
    function setLanguageByFilename(filename) {
      const ext = getExtension(filename);
      const lang = extToLang[ext] || "plaintext";
      monaco.editor.setModelLanguage(editor.getModel(), lang);
    }

    // Monaco Editor 초기화
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
    require(["vs/editor/editor.main"], function () {
      editor = monaco.editor.create(document.getElementById("editor"), {
        value: `foo bar\nfoo baz\n하나 둘 셋\nhello world`,
        language: "plaintext",
        theme: "vs-dark",
        automaticLayout: true,
        fontFamily: "Cascadia Mono, monospace",
        fontSize: 14,
        wordWrap: "on",
        folding: true,
        minimap: { enabled: true, side: "right" },
        lineNumbers: "on",
        cursorBlinking: "smooth",
        scrollbar: { vertical: "visible", horizontal: "visible" }
      });
    });

    // Aioli 초기화
    let CLI;
    (async () => {
      CLI = await new Aioli(["base/1.0.0", {
        tool: "sed",
        version: "4.8",
        reinit: true
      }]);
    })();

    // 간단한 shell-like 파서 (따옴표 처리)
    function parseArgs(input) {
      const regex = /'([^']*)'|"([^"]*)"|(\S+)/g;
      const args = [];
      let match;
      while ((match = regex.exec(input)) !== null) {
        if (match[1] !== undefined) args.push(match[1]);
        else if (match[2] !== undefined) args.push(match[2]);
        else args.push(match[3]);
      }
      return args;
    }

    // sed 실행 → Undo/Redo 지원
    async function runSed() {
      const text = editor.getValue();
      const cmdLine = document.getElementById("cmd").value.trim();
      if (!cmdLine) return;

      const args = parseArgs(cmdLine);
      await CLI.mount({ name: "input.txt", data: text });

      try {
        const output = await CLI.exec("sed", [...args, "input.txt"]);
        // setValue 대신 executeEdits 사용 → Undo/Redo 가능
        const model = editor.getModel();
        const fullRange = model.getFullModelRange();
        editor.pushUndoStop();
        editor.executeEdits("sed-run", [{ range: fullRange, text: output }]);
        editor.pushUndoStop();
      } catch (err) {
        alert("에러: " + err);
      }
    }

    // beforeunload
    window.addEventListener("beforeunload", e => { e.preventDefault(); e.returnValue = ""; });

    // 버튼 클릭
    document.getElementById("run").onclick = runSed;

    // 입력창에서 엔터키 → 실행
    document.getElementById("cmd").addEventListener("keydown", e => {
      if (e.key === "Enter") { e.preventDefault(); runSed(); }
    });

    // --- 파일 입출력 기능 추가 ---

    // Drag & Drop 로드
    document.addEventListener("dragover", e => { e.preventDefault(); });
    document.addEventListener("drop", e => {
      e.preventDefault();
      if (e.dataTransfer.files.length > 0) {
        const file = e.dataTransfer.files[0];
        currentFilename = file.name;
        const reader = new FileReader();
        reader.onload = ev => {
          const text = ev.target.result.replace(/\r\n/g, "\n");
          editor.setValue(text);
          setLanguageByFilename(currentFilename);
        };
        reader.readAsText(file, "utf-8");
      }
    });

    // Ctrl+O → 파일 열기
    document.addEventListener("keydown", e => {
      if (e.ctrlKey && e.key.toLowerCase() === "o") {
        e.preventDefault();
        const input = document.createElement("input");
        input.type = "file";
        input.accept = "*/*";
        input.onchange = ev => {
          const file = ev.target.files[0];
          if (!file) return;
          currentFilename = file.name;
          const reader = new FileReader();
          reader.onload = ev2 => {
            const text = ev2.target.result.replace(/\r\n/g, "\n");
            editor.setValue(text);
            setLanguageByFilename(currentFilename);
          };
          reader.readAsText(file, "utf-8");
        };
        input.click();
      }
    });

    // Ctrl+S → 파일 저장
    document.addEventListener("keydown", e => {
      if (e.ctrlKey && e.key.toLowerCase() === "s") {
        e.preventDefault();
        const text = editor.getValue();
        const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = currentFilename || "untitled.txt";
        a.click();
        URL.revokeObjectURL(url);
      }
    });
  </script>
</body>
</html>
